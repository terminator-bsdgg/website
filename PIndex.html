<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="verdammt">
        <meta name="keywords" content="lol,wtf">
        <meta name="copyright" content="IN20">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>STARTSEITE || TERMINATOR</title>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/fontawesome.css">
        <link rel="stylesheet" type="text/css" href="css/dataTables.bootstrap5.min.css">
        <script src="js/jquery-3.6.0.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script src="js/datatables.min.js"></script>
        <script src="js/dataTables.bootstrap5.min.js"></script>
        <script src="js/litepicker.js"></script>
        <style>
            body {
                display: grid;
                grid-gap: 0;
                grid-template-rows: auto 1fr 71px;
                overflow-x: hidden;
                min-height: 100vh; 
                background-color: #fffefd;
                align-content: flex-start;
                background-image: url("img/hmm.png");
            }
            #body-overlay {
                position: absolute;
                z-index: 9999;
                width: 100%;
                height: 100%;
                opacity: 1;
                background-color: #ffffff;
                transition: opacity 1s;
                display: flex;
                align-content: center;
                align-items: center;
                justify-content: center;
            }
            #body-overlay > h1 {
                color: var(--bs-gray-500, #adb5bd);
                margin: 0
            }
            header {
                grid-column: 1 / 3;
                grid-row: 1 / 1;
                display: flex;
                flex-direction: column;
                align-self: flex-start;
                background-color: #5858b5;
                height: 50px;
                color: #fff;
                justify-content: center;
            }
            footer {
                height: 50px;
                color: white; 
                grid-column: 1 / 3;
                grid-row: 3 / 3;
                align-self: flex-end;
                background-color: #5858b5;
                text-shadow: 0 1px 0 black;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            main {
                grid-column: 1 / 3;
                grid-row: 2 / 2;
                display: flex;
                align-items: flex-start;
                justify-content: center;
                padding: 0 5%;
            }
            main > div.row:first-of-type {
                flex: 0 1 100%
            }
            #mobile-navbar {
                display: block;
                margin: auto 20px auto auto;
            }
            ul.dropdown-menu {
                box-shadow: 0 0 5px 1px #0000008a
            }
            footer a, footer a:hover {
                border-bottom: 1px dotted #ffffff;
                text-decoration: none;
                color: #ffffff;
            }
            .alert-info.messageboxContainer {
                border-color: #bbd8e6
            }
            .alert-warning.messageboxContainer {
                border-color: #f2e7c4
            }
            .alert-danger.messageboxContainer {
                border-color: #e5babe
            }
            .alert-success.messageboxContainer {
                border-color: #b9dac1
            }
            .messageboxIcon {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0.714rem 0.357rem;
                align-self: stretch;
            }
            .messageboxIcon.info {
                background-color: #bbd8e6;
                color: #437b95
            }
            .messageboxIcon.danger {
                background-color: #e5babe;
                color: #911
            }
            .messageboxIcon.success {
                background-color: #b9dac1;
                color: #508d50
            }
            .messageboxIcon.warning {
                background-color: #f2e7c4;
                color: #918130
            }
            .messageboxIcon > i {
                font-size: 1.5625rem
            }
            .messageboxText {
                padding: 0.5rem;
                margin: 0.5rem;
                width: 100%;
            }
            .messageboxContainer {
                display: flex;
                align-items: center;
                padding: 0;
                position: relative
            }
            .messageboxText button.close {
                margin: 0 0 auto auto;
            }
            .messageboxText ul {
                list-style-position: inside;
                margin: 0;
                padding: 0;
            }
            #logo {
                background-image: url("img/termiconator.png");
                background-repeat: no-repeat;
                background-size: 41px 49px;
                background-position: "top left";
                width: 41px;
                height: 49px;
            }
            @font-face {
                font-family: "Font Awesome 5 Brands";
                font-style: normal;
                font-weight: 400;
                font-display: block;
                src: url("font/free-fa-brands-400.woff") format("woff")
            }
            @font-face {
                font-family: "Font Awesome 5 Free";
                font-style: normal;
                font-weight: 400;
                font-display: block;
                src: url("font/free-fa-regular-400.woff") format("woff")
            }
            @font-face {
                font-family: "Font Awesome 5 Pro";
                font-style: normal;
                font-weight: 400;
                font-display: block;
                src: url("font/free-fa-regular-400.woff") format("woff")
            }
            @font-face {
                font-family: "Font Awesome 5 Free";
                font-style: normal;
                font-weight: 900;
                font-display: block;
                src: url("font/free-fa-solid-900.woff") format("woff")
            }
            @font-face {
                font-family: "Font Awesome 5 Pro";
                font-style: normal;
                font-weight: 900;
                font-display: block;
                src: url("fonts/free-fa-solid-900.woff") format("woff")
            }
            @media only screen and (max-width: 600px) {
                .fritz {
                    margin-left: calc(var(--bs-gutter-x) * 0.5);
                }
                table.dataTable thead > tr > th {
                    font-weight: 600;
                }
                *:not(h1, h2, h3, h4, h5, h6, .messageboxIcon > i, h1 > span, h2 > span, h3 > span, h4 > span, h5 > span, h6 > span) {
                    font-size: 14px !important;
                }
                main {
                    padding: 0 2%
                }
                #second-navbar, #mobile-navbar {
                    margin-right: 2%;
                }
                #first-navbar {
                    margin-left: 2%;
                }
                #mobile-navbar {
                    display: block;
                }
                #second-navbar {
                    display: none;
                }
                .formContainer {
                    flex-direction: column;
                }
                .formContainer > label {
                    margin-right: 0;
                }
                .formContainer > label:not(:first-child), .formContainer > select:not(:first-child), .formContainer > input:not(:first-child), .formContainer > button:not(:first-child) {
                    margin-left: 0;
                }
            }
            @media only screen and (min-width: 600px) {
                table.dataTable thead > tr > th {
                    font-weight: 600;
                }
                *:not(h1, h2, h3, h4, h5, h6, .messageboxIcon > i, h1 > span, h2 > span, h3 > span, h4 > span, h5 > span, h6 > span) {
                    font-size: 14px !important;
                }
                #second-navbar, #mobile-navbar {
                    margin-right: 2%;
                }
                #first-navbar {
                    margin-left: 2%;
                }
                #mobile-navbar {
                    display: block;
                }
                #second-navbar {
                    display: none;
                }
                .formContainer {
                    flex-direction: column;
                }
                .formContainer > label {
                    margin-right: 0;
                }
                .formContainer > label:not(:first-child), .formContainer > select:not(:first-child), .formContainer > input:not(:first-child), .formContainer > button:not(:first-child) {
                    margin-left: 0;
                }
            }
            @media only screen and (min-width: 768px) {
                *:not(h1, h2, h3, h4, h5, h6, .messageboxIcon > i, h1 > span, h2 > span, h3 > span, h4 > span, h5 > span, h6 > span) {
                    font-size: 14px !important;
                }
                .formContainer {
                    flex-direction: row;
                    align-content: center;
                    align-items: center;
                }
                .formContainer > label:not(:first-child), .formContainer > select:not(:first-child), .formContainer > input:not(:first-child), .formContainer > button:not(:first-child) {
                    margin-left: 0.5rem;
                }
                .formContainer > label, .formContainer > select, .formContainer > input, .formContainer > button {
                    margin-top: 0;
                }
                .row > label {
                    align-self: center;
                }
                table.dataTable thead > tr > th {
                    font-weight: 600;
                }
                main {
                    padding: 0 2%
                }
                #second-navbar, #mobile-navbar {
                    margin-right: 2%;
                }
                #first-navbar {
                    margin-left: 2%;
                }
                #mobile-navbar {
                    display: none;
                }
                #second-navbar {
                    display: block;
                }
            }
            @media only screen and (min-width: 992px) {
                .formContainer {
                    flex-direction: row;
                    align-content: center;
                    align-items: center;
                }
                .formContainer > label:not(:first-child), .formContainer > select:not(:first-child), .formContainer > input:not(:first-child), .formContainer > button:not(:first-child) {
                    margin-left: 0.5rem;
                }
                .formContainer > label, .formContainer > select, .formContainer > input, .formContainer > button {
                    margin-top: 0;
                }
                #mobile-navbar {
                    display: none;
                }
                table.dataTable thead > tr > th {
                    font-weight: bold;
                }
                *:not(h1, h2, h3, h4, h5, h6, .messageboxIcon > i, h1 > span, h2 > span, h3 > span, h4 > span, h5 > span, h6 > span) {
                    font-size: 16px !important;
                }
                main {
                    padding: 0 5%
                }
                #second-navbar, #mobile-navbar {
                    margin-right: 5%;
                }
                #first-navbar {
                    margin-left: 5%;
                }
                #mobile-navbar {
                    display: none;
                }
                #second-navbar {
                    display: block;
                }
            }
            @media only screen and (min-width: 1200px) {
                .formContainer {
                    flex-direction: row;
                    align-content: center;
                    align-items: center;
                }
                .formContainer > label {
                    margin-right: 0.5rem;
                }
                .formContainer > label:not(:first-child), .formContainer > select:not(:first-child), .formContainer > input:not(:first-child), .formContainer > button:not(:first-child) {
                    margin-left: 0.5rem;
                }
                .formContainer > label, .formContainer > select, .formContainer > input, .formContainer > button {
                    margin-top: 0;
                }
                table.dataTable thead > tr > th {
                    font-weight: bold;
                }
                main {
                    padding: 0 5%
                }
                #second-navbar, #mobile-navbar {
                    margin-right: 5%;
                }
                #first-navbar {
                    margin-left: 5%;
                }
                #mobile-navbar {
                    display: none;
                }
                #second-navbar {
                    display: block;
                }
            }
        </style>
        <script>
            // Dürfen Terminersteller ihre eigenen Termine löschen?
            // Wie kurzfristig können Termine geändert werden?
            // Ist eine Übersicht vergangener Termine nötig?
            // TODO: Wenn gerade eine Konferenz stattfindet, muss ein Timer laufen, der die Meldung über eine
            // laufende Konferenz ausblendet, wenn sie vorbei ist!
            var systemInfosEventSource = null;
            const currentReservations = [];
            function updateSystemInfos() {
                if (systemInfosEventSource === null || systemInfosEventSource["readyState"] == 2) {
                    systemInfosEventSource = new EventSource("sse_test.php");
                    systemInfosEventSource.onmessage = function(event) {
                        if ($("#mainModal").attr("data-name") == "systemInfos") {
                            let data = JSON.parse(event["data"]);
                            let statsText = "";
                            if (data.hasOwnProperty("osname")) {
                                statsText += "<tr><td class='align-top'>Kernelversion</td><td>" + data["osname"] + "</td></tr>";
                            }
                            if (data.hasOwnProperty("arch")) {
                                statsText += "<tr><td class='align-top'>Architektur</td><td>" + data["arch"] + "</td></tr>";
                            }
                            if (data.hasOwnProperty("cpus")) {
                                statsText += "<tr><td class='align-top'>CPU</td><td>" + data["cpus"][0]["model"];
                                for (let [index, cpu] of data["cpus"].entries()) {
                                    statsText += "<div>CPU #" + index + ":<div class='ps-3'>Takt: " + cpu["speed"] + "MHz</div></div>";
                                }
                                statsText += "</td></tr>";
                            }
                            if (data.hasOwnProperty("freememory") && data.hasOwnProperty("totalmemory")) {
                                statsText += "<tr><td class='align-top'>Speicher</td><td>" + data["freememory"] + " MB/" + data["totalmemory"] + " MB (" + Math.floor(((data["freememory"] / data["totalmemory"]) *100)) + " %)</td></tr>";
                            }
                            if (data.hasOwnProperty("hostname")) {
                                statsText += "<tr><td class='align-top'>Host</td><td>" + data["hostname"] + "</td></tr>";
                            }
                            if (data.hasOwnProperty("uptime")) {
                                statsText += "<tr><td class='align-top'>Laufzeit</td><td>" + data["uptime"].duration() + "</td></tr>";
                            }
                            $("#systemInfosTable").html(statsText);
                        }
                        else {
                            systemInfosEventSource.close();
                            systemInfosEventSource = null;
                        }
                    };
                }
            }
            function showReservationDetails(id) {
                let index = currentReservations.findIndex(key => key["id"] === id);
                if (index >= 0) {
                    $("#reservationDescription").html(currentReservations[index]["description"]);
                    $("#reservationOrganiser").html(currentReservations[index]["organiser"]);
                    $("#reservationStart").html(currentReservations[index]["start"]);
                    $("#reservationEnd").html(currentReservations[index]["end"]);
                }
            }
            function getReservations() {
                $.get("dataTables.php", {
                    type: "today"
                }).done(function(response) {
                    let data = JSON.parse(response);
                    Object.assign(currentReservations, data["reservations"]);
                    let items = "<div class='list-group'>";
                    $("#todaysReservationDate").html(data["date"]);
                    for (reservation of data["reservations"]) {
                        items += "<button type='button' class='list-group-item list-group-item-action' onclick='showReservationDetails(" + reservation["id"] + ")'><div class='d-flex w-100 justify-content-between'>";
                        items += "<h5 class='mb-1'>" + reservation["description"] + "</h5>";
                        items += "<span class='badge bg-primary rounded-pill'><i class='fas fa-hourglass-half'></i> 10:00 Uhr</span></div>";
                        items += "<p class='m-0 text-secondary'>" + reservation["booker"] + "</p></button>";
                        //fas fa-circle für laufende konferenzen
                    }
                    items += "</div>";
                    $("#todaysReservationsList").html(items);
                }).fail(function(response) {
                    $("#reservationsContainer").prepend(Alert.create("danger", response["status"] + ": " + response["statusText"]));
                }).always(function() {
                });
            }
            class Alert {
                static create(type, message, closeable = true, classes = "") {
                    type = type.toLowerCase();
                    let icons = {
                        danger: "fas fa-exclamation-circle",
                        primary: "fas fa-info-circle",
                        warning: "fas fa-exclamation-triangle",
                        success: "fas fa-check-circle"
                    };
                    if (!["primary", "success", "danger", "warning"].includes(type)) {
                        type = "primary";
                    }
                    return "<div class='" + (closeable ? "alert-dismissible " : "") + "alert alert-" + type + " messageboxContainer " + classes + "' role='alert'><div class='messageboxIcon " + type + "'><i class='" + icons[type] + "'></i></div><div class='messageboxText'>" + message + (closeable ? "</div><button type='button' class='btn-close position-static align-self-start' data-bs-dismiss='alert' aria-label='Schließen'></button>" : "") + "</div></div>";
                }
            }
            Number.prototype.duration = function() {
                let sec_num = parseInt(this, 10);
                let weeks = Math.floor((sec_num / 3600 / 24) / 7);
                let days = Math.floor((sec_num / 3600 / 24) % 7);
                let hours = Math.floor((sec_num / 3600) % 24);
                let minutes = Math.floor((sec_num / 60) % 60);
                let seconds = sec_num % 60;
                let duration = "";
                if (weeks >= 1) {
                    duration += weeks + (weeks >= 2 ? " Wochen, " : " Woche, ");
                }
                if (days >= 1) {
                    duration += days + (days >= 2 ? " Tage, " : " Tag, ");
                }
                if (hours >= 1) {
                    duration += hours + (hours >= 2 ? " Stunden, " : " Stunde, ");
                }
                if (minutes >= 1) {
                    duration += minutes + (minutes >= 2 ? " Minuten, " : " Minute, ");
                }
                if (seconds >= 1) {
                    duration += seconds + (seconds >= 2 ? " Sekunden, " : " Sekunde, ");
                }
                return duration.substr(0, duration.length -2);
            }
            $(window).on("load", function() {
                $("#body-overlay").empty();
                $("#body-overlay").css("opacity", 0).on("transitionend", function() {
                    $(this).remove();
                    $("body").removeClass("overflow-hidden");
                });
            });
            $(document).on("DOMContentLoaded", function() {
                /*calendar = new FullCalendar.Calendar($("#calendar")[0], {
                    initialView: "timeGrid",
                    locale: "de",
                    events: "calendar.php",
                    nowIndicator: true,
                    selectable: false,
                    allDaySlot: false,
                    slotMinTime: "08:00:00",
                    slotMaxTime: "21:00:00",
                    expandRows: true,
                    dateClick: function(info) {
                        //console.log(info);
                    },
                    headerToolbar: {
                        left: 'prev,today,next',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    select: function(selectionInfo) {
                        $("#createNewReservationButton").attr("data-selected-date", selectionInfo["startStr"]).removeAttr("disabled");
                        console.log(selectionInfo);
                    },
                    eventClick: function(info) {
                        let eventData = calendar.getEventById(info["event"]["_def"]["publicId"]);
                        //"2022-02-08T10:10:00+01:00"
                        // Datumsformat ist ISO-Format, daher können Teile daraus einfach mit String-Methoden extrahiert werden.
                        // Beim Datum selber müssen zur Anzeige vielleicht verschiedene Formate benutzt werden.
                        let dateArray = eventData["startStr"].slice(0, 10).split("-");
                        let date = dateArray[2] + "." + dateArray[1] + "." + dateArray[0];
                        let startTime = eventData["startStr"].slice(11, 16) + " Uhr";
                        let endTime = (eventData["allDay"] ? "(Ganztägig)" : eventData["endStr"].slice(11, 16) + " Uhr");
                        let content = "<div class='row'><div class='col-md-3'>Beschreibung:</div><div class='col-md-9'>" + (eventData["title"] !== "" ? eventData["title"] : "(Nicht angegeben)") + "</div></div>";
                        content += "<div class='row mt-2'><div class='col-md-3'>Veranstalter:</div><div class='col-md-9'>" + (info["event"]["extendedProps"].hasOwnProperty("booker") ? info["event"]["extendedProps"]["booker"] : "(Nicht angegeben)") + "</div></div>";
                        content += "<div class='row mt-2'><div class='col-md-3'>Datum:</div><div class='col-md-9'>" + date + "</div></div>";
                        content += "<div class='row mt-2'><div class='col-md-3'>Start:</div><div class='col-md-9'>" + startTime + "</div></div>";
                        content += "<div class='row mt-2'><div class='col-md-3'>Ende:</div><div class='col-md-9'>" + endTime + "</div></div>";
                        content += "</div>";
                        let data = {
                        modal: {
                            name: "eventInfos"
                        },
                        title: {
                            text: "Termininformationen"
                        },
                        content: {
                            text: content,
                            options: {
                                scroll: true
                            }
                        }
                    };
                    Modal.create(data);
                    }
                });
                calendar.render();
                */
                getReservations();
                setInterval(getReservations, 60*1000);
                let date = new Date();
                $("footer").html("<a href='#'>&copy; " + (date.getFullYear() >= 2022 ? "2021-" + date.getFullYear() : date.getFullYear()) + " BSDGG/IN20/FIAE</a>");
                $("a[href='#systemInfos']").click(function() {
                    let content = "<table class='table-sm w-100'>";
                    content += "<thead>";
                    content += "<tr>";
                    content += "<th class='w-25'>Eigenschaft</th>";
                    content +=" <th>Wert</th>";
                    content += "</tr>";
                    content += "</thead>";
                    content += "<tbody id='systemInfosTable'>";
                    content += "</tbody>";
                    content += "</table>";
                    let data = {
                        modal: {
                            name: "systemInfos"
                        },
                        title: {
                            text: "Systeminformationen"
                        },
                        content: {
                            text: content,
                            options: {
                                scroll: true
                            }
                        }
                    };
                    Modal.create(data);
                    updateSystemInfos();
                });
            });
        </script>
    </head>
    <body>
        <div id="body-overlay" class="m-0 p-0 overflow-hidden">
            <noscript>
                <div class="alert alert-danger messageboxContainer" role="alert">
                    <div class="messageboxIcon danger">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="messageboxText">Um diese Seite nutzen zu können, muss JavaScript aktiviert sein.</div>
                </div>
            </noscript>
            <div class="spinner-border mr-2" style="border-width: 5px; color: var(--bs-gray-500)"></div>
        </div>
        <header>
            <nav class="navbar navbar-expand-sm p-0" id="navigation">
                <a class="navbar-brand ms-3 mb-0" href="#">
                    <div id="logo"></div>
                </a>
            </nav>
        </header>
        <main>
            <div class="row mt-4" id="reservationsContainer">
                <h2 class="col-md-12 p-0 mb-3">Reservierungen für <span id="todaysReservationDate"></span></h2>
                <div class="list-group col-md-12" id="todaysReservationsList">
                </div>
            </div>
        </main>
        <footer></footer>
        <div class="modal fade" id="reservationDetailsModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title"></h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-3">Beschreibung:</div>
                            <div class="col-md-9" id="reservationDescription"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">Veranstalter:</div>
                            <div class="col-md-9" id="reservationOrganiser"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">Start:</div>
                            <div class="col-md-9" id="reservationStart"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">Ende:</div>
                            <div class="col-md-9" id="reservationEnd"></div>
                        </div>
                    </div>
                    <div class="modal-footer"></div>
                </div>
            </div>
        </div>
    </body>
</html>